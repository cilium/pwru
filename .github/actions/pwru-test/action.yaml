name: PWRU Test
description: PWRU tool test action

inputs:
  test-name:
    description: "Test name"
    required: true
  pwru-flags:
    description: "PWRU tool flags"
    required: false
  pwru-pcap-filter:
    description: "PWRU tool PCAP filter"
    required: false
  setup:
    description: "Setup commands"
    required: false
  gen-traffic:
    description: "Generate traffic commands"
    required: false
  expected-output-pattern:
    description: "Expected output pattern"
    required: true
  ssh-port:
    description: "SSH port for VM on a host"
    required: false
    default: "2222"

runs:
  using: composite
  steps:
    - name: PWRU test
      uses: cilium/little-vm-helper@e5b2424f49a2055186b7ac33e6a83b7c992b8f3a # v0.0.24
      with:
        ssh-port: ${{ inputs.ssh-port }}
        provision: 'false'
        cmd: |
          set -x

          ${{ inputs.setup }}

          /host/pwru/pwru \
            --output-tuple \
            --output-file=/tmp/pwru-${{ inputs.test-name }}.log \
            --ready-file=/tmp/pwru-${{ inputs.test-name }}.ready \
            ${{ inputs.pwru-flags }} \
            '${{ inputs.pwru-pcap-filter }}' \
            2>/tmp/pwru-${{ inputs.test-name }}.status &
          PWRU_PID=\$!

          while [ ! -f /tmp/pwru-${{ inputs.test-name }}.ready ]; do sleep 1; done

          ${{ inputs.gen-traffic }}

          kill \$PWRU_PID
          wait \$PWRU_PID

          grep -P '${{ inputs.expected-output-pattern }}' /tmp/pwru-${{ inputs.test-name }}.log

    - name: Fetch artifacts from LVH VM
      if: ${{ !success() }}
      uses: cilium/little-vm-helper@e5b2424f49a2055186b7ac33e6a83b7c992b8f3a # v0.0.24
      with:
        ssh-port: ${{ inputs.ssh-port }}
        provision: 'false'
        cmd: |
          mkdir -p /host/logs/${{ inputs.test-name }}
          cp /tmp/pwru-* /host/logs/${{ inputs.test-name }}

    - name: Upload artifacts
      if: ${{ !success() }}
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ inputs.test-name }}
        path: ./logs/${{ inputs.test-name }}/pwru-*
